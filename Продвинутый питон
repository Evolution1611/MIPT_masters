## Домашнее задание 
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
Вам представлены данные об оттоке клиентов некоторого банка.
нужно установить, чем ушедшие клиенты отличаются от лояльных и как между собой связаны различные признаки, определяющие клиентов.
import pandas as pd
churn_data = pd.read_csv('C:\\Users\\shere\\OneDrive\\Рабочий стол\\MFTI\\Advanced python\\churn.csv')
churn_data.head()
churn_data.info()
# Удалим неинформативные признаки и дубликаты
churn_data = churn_data.drop(['RowNumber', 'CustomerId', 'Surname'], axis=1)
churn_data.drop_duplicates()
### Столбцы таблицы:

RowNumber — номер строки таблицы (это лишняя информация, поэтому можете сразу от неё избавиться)

CustomerId — идентификатор клиента

Surname — фамилия клиента

CreditScore — кредитный рейтинг клиента (чем он выше, тем больше клиент брал кредитов и возвращал их)

Geography — страна клиента (банк международный)

Gender — пол клиента

Age — возраст клиента

Tenure — сколько лет клиент пользуется услугами банка

Balance — баланс на счетах клиента в банке

NumOfProducts — количество услуг банка, которые приобрёл клиент

HasCrCard — есть ли у клиента кредитная карта (1 — да, 0 — нет)

IsActiveMember — есть ли у клиента статус активного клиента банка (1 — да, 0 — нет)

EstimatedSalary — предполагаемая заработная плата клиента

Exited — статус лояльности (1 — ушедший клиент, 0 — лояльный клиент)
#### 9.1. Каково соотношение ушедших и лояльных клиентов? Покажите это на графике и дайте комментарий по соотношению.
fig, axes = plt.subplots(1, 1, figsize=(10, 5))
churn_data.Exited.value_counts(normalize=True).plot(kind='pie')
axes.set_title('Соотношение лояльных и ушедших клиентов')
Видим, что остается с банком лишь пятая часть от всех клиентов.
#### 9.2. Постройте график, показывающий распределение баланса пользователей, у которых на счету больше 2 500 долларов. Опишите распределение и сделайте выводы.
fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(10, 4))

axes[0].hist(x=churn_data[churn_data.Balance > 2500].Balance,
             label='Баланс',
             bins=30,
            )
axes[0].grid()
axes[0].set_title('Распределение баланса на счетах клиентов (>2500$)')
axes[1].boxplot(x=churn_data[churn_data.Balance > 2500].Balance,
                vert=False,
                
               )
Распределение величины баланса от 2500 до максимума выглядит нормальным. Большинство балансов приходится на промежуток от 100 тысяч до 130 тысяч долларов.
#### 9.3. Посмотрите на распределение баланса клиента в разрезе признака оттока. Как различаются суммы на накопительном счёте ушедших и лояльных клиентов? Подумайте и напишите, с чем это может быть связано, что может не устраивать ушедших клиентов в банке.
fig, axes = plt.subplots(nrows=2, ncols=2, figsize=(10, 10))

axes[0,0].grid()
axes[0,0].set_title('Распределение баланса лояльных клиентов')

sns.histplot(
    data=churn_data[(churn_data.Exited == 0)],
    x='Balance',
    bins=50,
    stat='percent',
    kde=True,
    ax=axes[0, 0],
    color='blue'
)

axes[0,1].grid()
axes[0,1].set_title('Распределение баланса ушедших клиентов')
sns.histplot(
    data=churn_data[(churn_data.Exited == 1)],
    x='Balance',
    bins=50,
    stat='percent',
    kde=True,
    ax=axes[0, 1],
    color='green',
)

Видно, что распредление баланса схоже на промежутке выше минимульных порогов. Но околонулевой баланс имеют клиенты с разным разбросом в отношении к банку - 25% ушедших клиентов и 40% оставшихся. Думаю, это может свидетельтвовать об успехе рекламной стратегии банка, которая привлекла людей с низкими балансами и смогла их удержать после конца кампании.

#### 9.4. Посмотрите на распределение возраста в разрезе признака оттока. В какой группе больше потенциальных выбросов? На какую возрастную категорию клиентов стоит обратить внимание банку?
fig, axes = plt.subplots(nrows=2, ncols=2, figsize=(12, 9))

sns.histplot(
    data=churn_data[(churn_data.Exited == 0)],
    x='Age',
    bins=20,
    stat='percent',
    kde=True,
    ax=axes[0, 0]
);
axes[0,0].grid()
axes[0,0].set_title('Распределение возраста лояльных клиентов')

sns.boxplot(
    data=churn_data[(churn_data.Exited == 0)],
    x='Age',
    ax=axes[0, 1],
);
axes[0,1].grid()
axes[0,1].set_title('Диаграмма размаха возраста лояльных клиентов')

sns.histplot(
    data=churn_data[(churn_data.Exited == 1)],
    x='Age',
    bins=20,
    stat='percent',
    kde=True,
    ax=axes[1, 0],
    color='green',
);
axes[1,0].grid()
axes[1,0].set_title('Распределение возраста ушедших клиентов')

sns.boxplot(
    data=churn_data[(churn_data.Exited == 1)],
    x='Age',
    ax=axes[1, 1],
    color='green',
);
axes[1,1].grid()
axes[1,1].set_title('Диаграмма размаха возраста ушедших клиентов');
Распределение по возрасту очень отличается для оставшихся и ушедших клиетов - лояльные клиенты обычно моложе (молодые - лояльнее). Это может быть связяано с особенностями продуктовой линейки банка, отсутствием таких услуг как наличие легкодоступных офисов, банкоматов и других услуг, которые ценны для более старшего поколения.
#### 9.5. Постройте график, который показывает взаимосвязь кредитного рейтинга клиента и его предполагаемой зарплаты. Добавьте расцветку по признаку оттока клиентов. Какова взаимосвязь между признаками? Если не видите явной взаимосвязи, укажите это.

#### 9.6. Кто чаще уходит, мужчины или женщины? Постройте график, который иллюстрирует это.
fig, axes = plt.subplots(1, 2, figsize=(10, 4))

axes[0].pie(
    churn_data[churn_data.Exited == 0].Gender.value_counts(),
    labels=churn_data[churn_data.Exited == 0].Gender.value_counts().index,
    autopct='%.1f%%',
    colors=['blue','green'],
    explode=[0, 0.05]
)
axes[0].set_title('Распределение полов лояльных клиентов')

axes[1].pie(
    churn_data[churn_data.Exited == 1].Gender.value_counts(),
    labels=churn_data[churn_data.Exited == 1].Gender.value_counts().index,
    autopct='%.1f%%',
    colors=['green','blue'],
    explode=[0, 0.05]
)
axes[1].set_title('Распределение полов ушедших клиентов')
Здесь наглядно видно, что женщины менее лояльны к банку, чем мужчины. Интересно посмотреть взаимосвязь с манерой предоставления услуг банком и взаимодействием с клиетами. (А возможно это просто банк Открытие, который сотрудничает со Спартаком и привлекает болельщиков-мужчин!)
#### 9.7. Как отток клиентов зависит от числа приобретённых у банка услуг? Для ответа на этот вопрос постройте многоуровневую столбчатую диаграмму.
fig, axes = plt.subplots(1, 1, figsize=(10, 5))
sns.barplot(
    data=churn_data.groupby('NumOfProducts', as_index=False).Exited.value_counts(),
    x='NumOfProducts',
    y='count',
    hue='Exited')
axes.set_title('Соотношение лояльных и ушедших клиентов в зависимости от числа продуктов');
Здесь интересная ситуация - люди, пользующиеся продуктами банка меньше - более лояльны. С другой стороны - здесь вопрос к данным. Исторически накопленным итогом приобретавшие услуги? Тогда - на этапе первой услуги уходит четверть, дальше вторая услуга наращивает лояльность. При обращении за дальнейщими услугами возникает явный тред к закрытию счетов.
#### 9.8. Как влияет наличие статуса активного клиента на отток клиентов? Постройте диаграмму, иллюстрирующую это. Что бы вы предложили банку, чтобы уменьшить отток клиентов среди неактивных?
fig, axes = plt.subplots(1, 1, figsize=(10, 5))
sns.barplot(
    data=churn_data.groupby('IsActiveMember', as_index=False).Exited.value_counts(),
    x='IsActiveMember',
    y='count',
    hue='Exited')
axes.set_title('Соотношение лояльных и ушедших клиентов в зависимости от участия в программе лояльности')
Видим, что статус активного клиента имеет прмую зависимость с лояльстью к банку. (Но в купе с пунктом выше - эта актиность скорее всего ограничена 2 продуктами)
#### 9.9. В какой стране доля ушедших клиентов больше? Постройте тепловую картограмму, которая покажет это соотношение на карте мира. Предположите, с чем это может быть связано.
churn_data_geo = churn_data.groupby('Geography')[['Exited']].mean()

fig = px.choropleth(
    data_frame=churn_data_geo, 
    locations=churn_data_geo.index, 
    locationmode = "country names", 
    color="Exited",
    range_color=[0, 0.5], 
    title='Доля ушедших клиентов по странам', 
    width=800, 
    height=600, 
    color_continuous_scale='tealrose'
)

#отображаем график
fig.show()
Видим, что Франция и Испания удеживают клиентов лучше, чем Германия. Это может быть свзано с многими особенностями, историей работы банка в стране и клиентской базой в каждой стране.
#### 9.10. Переведите числовой признак CreditScore в категориальный. Для этого воспользуйтесь функцией get_credit_score_cat(), которая приведена ниже. Примените её к столбцу CreditScore и создайте новый признак CreditScoreCat — категории кредитного рейтинга.
def get_credit_score_cat(credit_score):
    if credit_score >= 300 and credit_score < 500:
        return "Very_Poor"
    elif credit_score >= 500 and credit_score < 601:
        return "Poor"
    elif credit_score >= 601 and credit_score < 661:
        return "Fair"
    elif credit_score >= 661 and credit_score < 781:
        return "Good"
    elif credit_score >= 781 and credit_score < 851:
        return "Excellent"
    elif credit_score >= 851:
        return "Top"
    elif credit_score < 300:
        return "Deep"
churn_data['CreditScoreCat'] = churn_data.CreditScore.apply(lambda x: get_credit_score_cat(x))
pivot = churn_data.groupby(['Tenure', 'CreditScoreCat'], as_index=False).Exited.mean().pivot_table(
    values='Exited',
    columns='Tenure',
    index='CreditScoreCat')

heatmap = sns.heatmap(data=pivot, cmap='Blues')
heatmap.set_title('Тепловая карта уходящих клиентов в зависимости от кредитного рейтинга и стажа в банке')
- Сразу бросается в глаза, что клиенты с самым низким рейтингом уходят чаще. Более того, в самом начале (в первый год) Думаю, это происхолит после того, как они получат новости о присвоении рейтинга. 
- Как ни странно, клиенты с очень высоким рейтингом тоже уходят в первый год. Думаю, здесь применима обратная завиимость для объяснения - они не успевают провалиться в кредитном рейтинге и выплачивают короткий кредит и закрывают счет.
- тем не менее, клменты с зорошим рейтингом имеют больше всего шансов на то, чтобы остаться начиная со второго года.

